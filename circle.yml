machine:
  node:
    version: 6
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker
  environment:
    BUILD_VERSION: $(date +%Y%m%d%H%M)-$CIRCLE_BUILD_NUM

test:
  post:
    - >
      docker build
      --rm=false
      -t mojdigitalstudio/health-kick:$BUILD_VERSION
      --label 'maintainer=noms-studio-webops@digital.justice.gov.uk'
      --label 'build.number=$CIRCLE_BUILD_NUM'
      --label 'build.url=$CIRCLE_BUILD_URL'
      --label 'build.gitref=$CIRCLE_SHA1'
      .

deployment:
  dockerhub-and-stage:
    branch: master
    owner: noms-digital-studio
    commands:
      # Push image to docker hub
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
      - docker push mojdigitalstudio/health-kick:$BUILD_VERSION

      # Install AWS Elastic Beanstalk CLI
      - sudo apt-get install python-dev
      - sudo pip install awsebcli six

      # Create manifest and deploy to Elastic Beanstalk environment
      - yarn run plant-beanstalk $BUILD_VERSION
      - eb deploy --process --verbose
